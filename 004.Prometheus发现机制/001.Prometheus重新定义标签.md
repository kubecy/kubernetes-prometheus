# Prometheus重新定义标签

## 1.对target重新打标

- 对target重新打标是在数据抓取之前动态重写target标签的强大工具，在每个数据抓取配置中，可以定义多个relabel步骤，它们将按照定义的顺序依次执行；
  1. 对于发现的每个target，Prometheus默认会执行如下操作
     - job的标签设定为其所属的job_name的值；
     - \__address__标签的值为该target的套接字地址\<host>:\<port>
     - instance标签的值为\__address__的值；
     - \__scheme__标签的值为抓取该target上指标时使用的协议（http或https）；
     - \__metrics_path__标签的值为抓取该target上的指标时使用URI路径，默认为/metrics；
     - \__param__\<name>标签的值为传递的URL参数中第一个名称为\<name>的参数的值；
  2. 重新标记期间，还可以使用该target上以“\__meta__”开头的元标签；
     - 各服务发现机制为其target添加的元标签会有所不同；
  3. 重新标记完成后，该target上以“__”开头的所有标签都会被移除；
     - 若在relabel的过程中需要临时存储标签值，则要使用__tmp标签名称为前缀进行保存，以避免同Prometheus的内建标签冲突；

## 2.relabel_config

~~~yaml
# The source labels select values from existing labels. Their content is concatenated
# using the configured separator and matched against the configured regular expression
# for the replace, keep, and drop actions.
[ source_labels: '[' <labelname> [, ...] ']' ]

# Separator placed between concatenated source label values.
[ separator: <string> | default = ; ]

# Label to which the resulting value is written in a replace action.
# It is mandatory for replace actions. Regex capture groups are available.
[ target_label: <labelname> ]

# Regular expression against which the extracted value is matched.
[ regex: <regex> | default = (.*) ]

# Modulus to take of the hash of the source label values.
[ modulus: <int> ]

# Replacement value against which a regex replace is performed if the
# regular expression matches. Regex capture groups are available.
[ replacement: <string> | default = $1 ]

# Action to perform based on regex matching.
[ action: <relabel_action> | default = replace ]
~~~



